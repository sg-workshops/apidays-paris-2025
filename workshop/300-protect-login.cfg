### NEW 
peers mypeers
  server apidays
  # Track brute force attempt per IP addresses.
  table per_src_brute_force type ip size 1m expire 5m store gpc0
  
frontend dvapi-fe
  bind :80
  ### NEW 
  # Create a secondary SSL bind
  bind :443 ssl crt dvapi.pem 

  ## NEW
  # Track incoming connection
  acl is_http_abuser sc0_get_gpc0 -m int ge 3
  tcp-request connection track-sc0 src table mypeers/per_src_brute_force
  # Reject connection if user is abuser.
  tcp-request connection reject if is_http_abuser
  http-request reject if is_http_abuser


  # Redirect http->https
  http-request redirect scheme https code 307 if !{ ssl_fc }

  acl is_api path,word(1,/) -m str api logout
  use_backend api-be if is_api
  default_backend web-be

  # Activate HSTS if connection is over SSL
  #http-after-response set-header strict-transport-security "max-age=31536000" if { ssl_fc }

backend web-be
  server web 127.0.10.1:3000

backend api-be
  server web 127.0.10.2:3000
  ## NEW
  # Increment abuse counter (gpc0) if
  #   - login failed (401)
  http-after-response sc-inc-gpc0(0) if { status -m int 401 }
