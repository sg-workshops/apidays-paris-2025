global
  tune.lua.bool-sample-conversion normal
  # Load LUA helper scripts
  lua-load endpoints-helpers.lua


peers mypeers
  server apidays
  # Track brute force attempt per IP addresses.
  table per_src_brute_force type ip size 1m expire 5m store gpc0
  
frontend dvapi-fe
  bind :80
  # Create a secondary SSL bind
  bind :443 ssl crt dvapi.pem 

  # Track incoming connection
  acl is_http_abuser sc0_get_gpc0 -m int ge 3
  tcp-request connection track-sc0 src table mypeers/per_src_brute_force
  # Reject connection if user is abuser.
  tcp-request connection reject if is_http_abuser
  http-request reject if is_http_abuser


  # Redirect http->https
  http-request redirect scheme https code 307 if !{ ssl_fc }

  acl is_api path,word(1,/) -m str api logout
  use_backend api-be if is_api
  default_backend web-be

  # Activate HSTS if connection is over SSL
  #http-after-response set-header strict-transport-security "max-age=31536000" if { ssl_fc }

backend web-be
  server web 127.0.10.1:3000

backend api-be
  # Save current path to allow path normalisation
  http-request set-var(txn.path) path
  # /api/user/:user is special. replace username by {user} to normalize endpoint lookup
  http-request set-var-fmt(txn.path) "/%[var(txn.path),word(1,/,2)]/{user}" if { path -m beg /api/user/ }
  # Fetch endpoint configuration from map file
  http-request set-var(req.ep_data) var(txn.path),map(endpoints.map) 
  # deny the request for unknown endpoints
  http-request deny status 404 if !{ var(req.ep_data) -m found }
 
  # Extract current endpoint allowed methods
  http-request set-var(req.ep_method) var(req.ep_data)
  # Check if current endpoint accepts current method
  http-request lua.check-method if !METH_OPTIONS !METH_HEAD
  # Deny if invalid method
  http-request deny status 405 if { var(req.invalid_method),bool }

  # Check an authentication is provided
  acl has_auth http_auth_bearer -m found
  http-request set-var(txn.bearer) http_auth_bearer
  # Extract algorithm from JWT header
  http-request set-var(txn.jwt_alg) var(txn.bearer),jwt_header_query('$.alg') if has_auth
  # Check algorithm (as provided by application)
  http-request deny if has_auth !{ var(txn.jwt_alg) -m str "HS256" }
  # Validate JWT with application secret
  http-request deny if has_auth !{ var(txn.bearer),jwt_verify(txn.jwt_alg,"secret123") -m int 1 }

  ## NEW
  # Retrieve username from JWT token
  http-request set-var(txn.jwt_user) var(txn.bearer),jwt_payload_query('$.username')
  # Only users declared in admins.acl are allowed to be admin.
  http-request deny if !{ var(txn.jwt_user) -m str -f admins.acl } { var(txn.bearer),jwt_payload_query('$.isAdmin') -m str true  }

  ## NEW
  # Protect /api/user/USERNAME from deletion
  http-request deny if METH_DELETE { path -m beg /api/user/ } !{ path,word(3,/),strcmp(txn.jwt_user) -m int eq 0 }

  ## NEW
  # Protect /api/getNote?username=USERNAME
  http-request deny if { path -m str /api/getNote } !{ url_param(username),strcmp(txn.jwt_user) -m int eq 0 }



  server web 127.0.10.2:3000

  # Increment abuse counter (gpc0) if
  #   - login failed (401)
  #   - Attempt an unknown endpoint (404)
  #   - Invalid method detected (405)
  http-after-response sc-inc-gpc0(0) if { status -m int 401 404 405 }
